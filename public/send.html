<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="">
    <meta name="author" content="">
    <link rel="icon" href="../../favicon.ico">

    <title>Send new report</title>

    <link href="assets/bootstrap-3.3.7/css/bootstrap.min.css" rel="stylesheet">
    <link href="assets/jquery-ui-1.12.1/jquery-ui.min.css" rel="stylesheet">
    <link href="jquery.autocomplete.css" rel="stylesheet">

    <script src="assets/jquery-3.1.1/js/jquery-3.1.1.min.js" charset="utf-8"></script>
    <script src="assets/jquery-ui-1.12.1/jquery-ui.min.js" charset="utf-8"></script>
    <script src="assets/tabletojson/js/jquery.tabletojson.js" charset="utf-8"></script>
    <script src="assets/underscore-1.8.3/js/underscore-min.js" charset="utf-8"></script>

    <link href="style.css" rel="stylesheet">
</head>

<body>
    <div class="container">
        <div class="panel panel-default">
            <div class="panel-heading">
                <h3 class="panel-title">Данные отчета</h3>
            </div>

            <div class="panel-body">
                <form class="form-horizontal">
                    <div class="form-group">
                        <label for="location" class="col-sm-2 control-label">Локация</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="location" placeholder="Локация">
                            <span class="help-block">Введите название города или ашрама за который Вы отправляете отчет. Пример: "Санкт-Петербург", "Москва. Ашрам Бхактиведанты".</span>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="date" class="col-sm-2 control-label">Дата</label>
                        <div class="col-sm-10">
                            <input type="text" class="form-control" id="date" placeholder="Дата или событие">
                            <input type="hidden" id="date-type">
                            <span class="help-block">Введите дату отчета или название сбытия, напимер:
                              <span class="date-shortcut">Январь 2016</span>, <span class="date-shortcut">Марафон Прабхупады 2016</span>
                            </span>
                        </div>
                    </div>


                    <div class="form-group">
                        <label for="report" class="col-sm-2 control-label">Отчёт</label>
                        <div class="col-sm-10">
                            <div id="report" placeholder="Отчёт" contenteditable="true"></div>
                            <span class="help-block">Вставьте данные из Excel сюда.</span>
                        </div>
                    </div>

                    <div class="form-group">
                        <div class="col-sm-offset-2 col-sm-10">
                            <button type="submit" class="btn btn-default" id="send">Отправить</button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>
</body>

<script>

    // TODO: http://stackoverflow.com/questions/4815330/jquery-ui-autocomplete-with-item-and-id

    // Generates report object using specified location, date and table
    function generateReport(location, date, type, table) {
        var report = {
            location: location,
            type: type,
            date: date,
            records: [] // fill it later
        };

        // maps specified data a into report's record
        report.records = _.map(table, function(a) {
            return {
                name: a["Имя"],
                count: [parseCount(a["МБ"]), parseCount(a["БГ"]), parseCount(a["СР"]), parseCount(a["МЛ"])]
            }
        });

        return report;
    }

    function parseCount(value) {
        return parseInt(value || "0") || 0
    }

    $(document).ready(function() {

        $("#location").autocomplete({
          source: "locations.json",
        });

        $("#date").autocomplete({
          source: "events.json",
          select: function (event, ui) {
            var type = ui.item.type;
            $("#date-type").val(type);
          }
        });

        $("#send").bind('click', function(e) {
            e.preventDefault();
            var reportTable = $("table");
            var table = reportTable.tableToJSON();
            var location = $("#location").val();
            var date = $("#date").val();
            var type = $("#date-type").val();
            var report = generateReport(location, date, type, table);

            $.ajax({
                url: 'http://localhost:3000/api/report/new',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify(report),
                success: function(data) {
                    var sccess = data.success;
                    var errors = data.errors;
                    console.log(data);

                    $(".has-error").removeClass("has-error")
                    for (error of errors) {
                        $("#" + error.field).parent().addClass("has-error");
                    }
                }
            });
        });
    });
</script>

</html>
